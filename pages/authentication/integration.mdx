import { Callout } from "nextra-theme-docs";
import { Tab, Tabs } from "nextra-theme-docs";
import Image from "next/image";

# Authentication integration guide

## Introduction

In these getting-started guide you will learn how to level-up your web application with ROQ's advanced authentication
and user management capabilties.

<Callout emoji="ðŸ’¡">
  In case you are stuck, we are just one message away. Just join the [Community
  Slack](https://join.slack.com/t/roq-community/shared_invite/zt-1ly20yqpg-K03kNGxN1C7G1C0rr3TlSQ)
  and get instant responses from our engineers.
</Callout>

## (1) Install NPM packages

Install the following package(s) into your project:

<Tabs items={['Next.js', 'Express.js']}><Tab>

```shell
npm install @roq/nextjs
```

</Tab>
<Tab>

```shell
npm install @roq/expressjs
```

</Tab>
</Tabs>

## (2) Setup credentials

{/* TODO https://roqtech.atlassian.net/wiki/spaces/RC/pages/705232897/ROQ+Auth+Doc#(2)-Credentials */}

Login to [ROQ Console](https://console.roq.tech/), copy the needed credentials and paste them into the `.env` file of
your web application. You need to add the `ROQ_SECRET` variable. The value can be generated by
running `openssl rand -hex 32` on the
command line.

You can read more about the credentials [here](/authentication/advanced-topics/configuration).

## (3) Add routes for authentication

ROQ provides a wrapper which adds these four routes into your application: `/login`, `/logout`, `/session` and
`/callback`. You can read more about them [here](/authentication/advanced-topics/authentication-routes).

{/* TODO Install roq next.js */}

<Tabs items={['Next.js', 'Express.js']}><Tab>

Create a new file: `pages/api/[...roqAuth].ts` with this content. Next.js will automatically detect and import the
handler.

```typescript
import { handleAuth } from "@roq/nextjs";

export default handleAuth;
```

</Tab>
<Tab>
Import `auth` middleware and register it in your Express.js server. Middleware will automatically register new
routes.

```typescript
import express from 'express';
import { auth } from '@roq/expressjs';

const app = express();
app.use(auth());

```

</Tab>
</Tabs>

## (4) Protect frontend pages

You can use `requireNextAuth` to wrap non-public pages of your application. This disallowes non-authenticated users to open
the page and redirects them to the login-page.

<Tabs items={['Next.js']}><Tab>

```tsx
import { requireNextAuth } from "@roq/nextjs";

const MyPage = function () {
  return <Content>...</Content>;
};

export default requireNextAuth({
  redirectIfAuthenticated: true,
  redirectTo: "/login",
})(MyPage);
```

</Tab></Tabs>

## (5) Protect APIs

<Tabs items={['Next.js', 'Express.js']}><Tab>
On the server-side you can wrap your API handler with the `withAuth` function to enforce authentication. The function
throws an unauthorized error if the user is not authenticated.

```tsx
import { withAuth } from "@roq/nextjs";

async function handler(req: NextApiRequest, res: NextApiResponse) {
  const session = getServerSession(req);
  const user = session.user;
}

export default function apiHandler(req: NextApiRequest, res: NextApiResponse) {
  return withAuth(req, res)(handler);
}
```

</Tab>
<Tab>
On the server-side you can wrap your API handler with the `requireAuth` middleware to enforce authentication. The function
throws an unauthorized error if the user is not authenticated.

```tsx
import { requireAuth } from '@roq/expressjs';
import { Router } from 'express';

const router = new Router();

router.get('/', requireAuth);
```

</Tab>
</Tabs>

## What's next

ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ Thatâ€™s it! You successfully protected your application. Give it a try and register a new user. Of course, you can
individualize your authentication even further: [Feature Overview](/authentication#feature-overview).
