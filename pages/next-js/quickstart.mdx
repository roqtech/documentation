import { Steps, Callout } from "nextra/components"

# Quickstart

Learn how to create a Next.js project using ROQ BaaS, install ROQ SDK, and query data from the ROQ BaaS.

{/*
### Configure user schema and roles

*/}
<Steps>
### Create a Next.js application

To create a new Next.js project. Run this command:

```shell
npx create-next-app@latest
```

And the follow along the installation questions:

```shell
What is your project named? roq-baas-nextjs
Would you like to use TypeScript? No / Yes
Would you like to use ESLint? No / Yes
Would you like to use Tailwind CSS? No / Yes
Would you like to use `src/` directory? No / Yes
Would you like to use App Router? (recommended) No / Yes
Would you like to customize the default import alias (@/*)? No / Yes
What import alias would you like configured? @/*
```

### Install ROQ BaaS SDK

Install the necessary ROQ BaaS SDK for our project, which is `@roq/nextjs` and `@roq/cli` packages. 

```shell
npm install @roq/nextjs --save
npm install @roq/cli --save-dev
```

### Setup `.env`

Besides SDK, we need to copy the environment file from the ROQ Console. Make sure to choose the appropriate environment for our project, copy the environment values, and save it to the `.env` file in our root Next.js project directory. 

The environment `.env` file example:

```env
# Public variables, used on client - Delete these if you are not using Next.js
NEXT_PUBLIC_ROQ_CLIENT_ID=e3408733-0ac2-4596-8264-0a7da2481801
NEXT_PUBLIC_ROQ_PLATFORM_URL=https://qa01.roq-platform.com

# If you change the host or port on your local installation from https://book-story-v1-ca2b.vercel.app to another value,
# then you need to update the settings in the console as well. ROQ Console: https://console.roq.tech/
# Modify this to your application URL
NEXT_PUBLIC_BASE_URL=https://book-story-v1-ca2b.vercel.app

# Server variables used for ROQ connection
ROQ_BASE_URL=https://book-story-v1-ca2b.vercel.app
ROQ_PLATFORM_URL=https://qa01.roq-platform.com
ROQ_ENVIRONMENT_ID=e3408733-0ac2-4596-8264-0a7da2481801
ROQ_API_KEY=s3cr3t

# Server variables for ROQ auth
ROQ_SECRET=CHANGE_THIS_SECRET
ROQ_CLIENT_ID=e3408733-0ac2-4596-8264-0a7da2481801
ROQ_CLIENT_SECRET=4354520b-8264-0a7da2481801
ROQ_AUTH_CALLBACK_URL=https://book-story-v1-ca2b.vercel.app/api/auth/callback
ROQ_AUTH_LOGIN_URL=https://book-story-v1-ca2b.vercel.app/api/auth/login
ROQ_AUTH_LOGOUT_URL=https://book-story-v1-ca2b.vercel.app/api/auth/logout
ROQ_AUTH_URL=https://dgc7uw23yacn9f7vz6xm772m9.auth.qa01.roq-platform.com
DATABASE_URL=postgresql://username:password@somehost:5432/bookstory
ROQ_API_URL=https://book-story-v1-ca2b-baas.vercel.app
NEXT_PUBLIC_ROQ_API_URL=https://book-story-v1-ca2b-baas.vercel.app
```

### Generate SDK

Our Next.js project will work with ROQ BaaS by using a customize generated SDK. This process is necessary to generate Prisma types for SDK. To generate it, run the command below:

```shell
npx @roq/cli generate
```
The command generates a customizable SDK based on the Prisma BaaS schema and chosen environment. The default location for the code generated is `src/lib/roq`.

![generate roq sdk](/screenshots/generate-sdk.png)

Add `lib` folder to the `compilerOptions` in the TypeScript config file so that the new SDK can be recognized.

```json
"compilerOptions": {
  "paths": {
      "@/*": [
          "./src/*"
      ],
        "lib/*": [
          "./src/lib/*"
      ]
  },
}
```

### Configure Next.js with ROQ authentication

Before doing any data related query, we need to wrap the Next.js application with the `<RoqClientProvider>` context provider component. This provider enable the components in the application tree to access the customize generated SDK from our command earlier. You can put this code in `_app.tsx` file.

```jsx filename="_app.tsx"
import '@/styles/globals.css'
import type { AppProps } from 'next/app'
import { RoqClientProvider } from 'lib/roq'

export default function App({ Component, pageProps }: AppProps) {
  const backendHost = process.env.NEXT_PUBLIC_ROQ_API_URL as string
  const platformHost = process.env.NEXT_PUBLIC_ROQ_PLATFORM_URL as string

  return (
      <RoqClientProvider backendHost={backendHost} platformHost={platformHost}>
        <Component {...pageProps} />
      </RoqClientProvider>
  )
}
```

To make our Next.js project seamlessly work with ROQ Authentication, we need to configure the project first. Add file `pages/api/auth/[...roqAuth].ts` and fill with this code:

```ts filename="[...roqAuth].ts"
import { RoqAuth } from '@roq/nextjs';
export default RoqAuth({});
```

### Query data

For example, this is a snippet from the generated code for hook to find books with count data:

```ts filename="src/lib/roq/roq-hooks.ts"
export function useBookFindManyWithCount<
  T extends Prisma.bookFindManyArgs,
  R extends { data: GetFindResult<Prisma.$bookPayload<DefaultArgs>, T>[]; count: number },
>(args?: Prisma.SelectSubset<T, Prisma.bookFindManyArgs>, options?: RequestOptions, swrOptions?: SWRRequestOptions<R>) {
  const roq = useRoqClient();
  const key = JSON.stringify(['useBookFindManyWithCount', args || {}]);
  return useSWR<R, Error>(
    key,
    async () => {
      const result = await roq.book.findManyWithCount(args, options);
      return result as R;
    },
    {
      ...swrOptions,
      fallbackData: swrOptions?.initialData ?? swrOptions?.fallbackData,
    },
  );
}
```

To use the `useBookFindManyWithCount` method in a Next.js page, we need to import this code:

```ts
import { useRoqClient, useBookFindManyWithCount } from 'lib/roq';
```

and then use it, for example:

```ts 
const { data, error, isLoading, mutate } = useBookFindManyWithCount({
	  orderBy: {
      created_at: 'desc',
    }
});
```
We can display the `data` in the `index.tsx` page:

```ts 
<div>
    { isLoading ? (
        <p>Loading...</p>
      ) : error ? (
        <p>Error: {error.message}</p>
      ) : (
        <>
         <h1>Book Titles</h1>
         <br/>
         <ul>
             {data.data.map((book, index) => (
                 <li key={book.id}>
                    {index + 1}. {book.title} by {book.author} ({book.genre})
                 </li>
              ))}
          </ul>
        </>
      )
    }
</div>
```

### Start the Next.js application

To start the development server run this command:

```shell
npm run dev
```

And in the browser, go to `http://localhost:3000`. 

![Next.js Quickstart](/screenshots/nextjs-quickstart-demo.png)
</Steps>


{/*
You need a roq-session-cookie in the browser. You can copy paste the cookie from the existing generated app.
*/}